generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // Transaction pooler (6543) - app queries (prepared statements disabled in src/lib/db.ts)
  directUrl = env("DIRECT_URL")     // Session pooler (5432) - migrations only (supports DDL)
}

model course_modules {
  id           String   @id
  course_id    String
  module_id    String
  sort_order   Int
  custom_title String?

  // Course-specific customization (Phase 6 - Alternative to cloning)
  custom_notes        String? @db.Text // Add course-specific context without modifying original
  custom_context      String? @db.Text // Prerequisites, connections to other materials
  custom_objectives   String? @db.Text // Learning objectives specific to this course

  created_at   DateTime @default(now())
  courses      courses  @relation(fields: [course_id], references: [id], onDelete: Cascade)
  modules      modules  @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([course_id, module_id])
  @@unique([course_id, sort_order])
  @@index([course_id])
  @@index([module_id])
}

model courses {
  id              String                 @id
  title           String
  slug            String                 @unique
  description     String?
  author_id       String
  status          String                 @default("draft")
  featured        Boolean                @default(false)
  tags            String[]
  tracking_count  Int                    @default(0) // Number of users (learners) who started this course
  created_at      DateTime               @default(now())
  updated_at      DateTime               @updatedAt

  // Curriculum Map & Learning Paths (Curriculum Visualization Feature)
  prerequisite_course_ids String[]       @default([]) // Array of course IDs that must be completed first
  curriculum_position_x   Float?         @default(50) // Percentage (0-100) for horizontal position on curriculum map
  curriculum_position_y   Float?         @default(50) // Percentage (0-100) for vertical position on curriculum map

  course_modules  course_modules[]
  users           users                  @relation(fields: [author_id], references: [id], onDelete: Restrict)
  collaborators   course_collaborators[]
  course_tracking course_tracking[]

  // Progress tracking (Week 4)
  module_progress module_progress[]      @relation("CourseProgress")

  @@index([author_id])
  @@index([slug])
  @@index([status])
  @@index([tracking_count])
}

model media_files {
  id             String         @id
  filename       String
  original_name  String
  file_size      BigInt
  mime_type      String
  storage_path   String
  thumbnail_path String?
  uploaded_by    String
  created_at     DateTime       @default(now())
  users          users          @relation(fields: [uploaded_by], references: [id], onDelete: Restrict)
  module_media   module_media[]

  @@index([mime_type])
  @@index([uploaded_by])
}

model module_media {
  id            String      @id
  module_id     String
  media_file_id String
  created_at    DateTime    @default(now())
  media_files   media_files @relation(fields: [media_file_id], references: [id], onDelete: Cascade)
  modules       modules     @relation(fields: [module_id], references: [id], onDelete: Cascade)

  @@unique([module_id, media_file_id])
  @@index([media_file_id])
  @@index([module_id])
}

model modules {
  id               String                 @id
  title            String
  slug             String
  content          String?
  description      String?
  author_id        String
  parent_module_id String?
  sort_order       Int                    @default(0)
  module_number    String?
  status           String                 @default("draft")

  // Visibility & Sharing (Phase 1)
  visibility       String                 @default("public") // "public" | "private"

  // Cloning & Lineage (Phase 1)
  cloned_from      String?                // References modules.id (NULL if original)
  clone_count      Int                    @default(0) // Number of times this module was cloned

  // Quest Map & Gamification (Quest Map Feature)
  prerequisite_module_ids String[]       @default([]) // Array of module IDs that must be completed first
  quest_map_position_x    Float?         @default(50) // Percentage (0-100) for horizontal position
  quest_map_position_y    Float?         @default(50) // Percentage (0-100) for vertical position
  xp_reward              Int            @default(100) // XP earned on completion
  difficulty_level       String         @default("beginner") // beginner | intermediate | advanced | boss
  estimated_minutes      Int?           // Estimated time to complete
  quest_type             String         @default("standard") // standard | challenge | boss | bonus

  tags             String[]               @default([])
  created_at       DateTime               @default(now())
  updated_at       DateTime               @updatedAt
  course_modules   course_modules[]
  module_media     module_media[]
  users            users                  @relation(fields: [author_id], references: [id], onDelete: Restrict)
  modules          modules?               @relation("modulesTomodules", fields: [parent_module_id], references: [id])
  other_modules    modules[]              @relation("modulesTomodules")
  collaborators    module_collaborators[]

  // Clone lineage relation (self-referential)
  original_module  modules?               @relation("ModuleClones", fields: [cloned_from], references: [id], onDelete: SetNull)
  cloned_modules   modules[]              @relation("ModuleClones")

  // Progress tracking (Week 4)
  progress_records module_progress[]      @relation("ModuleProgressRecords")

  @@unique([parent_module_id, sort_order])
  @@index([author_id])
  @@index([parent_module_id])
  @@index([status])
  @@index([tags])
  @@index([visibility])       // For filtering public/private modules
  @@index([cloned_from])      // For tracking clone lineage
  @@index([status, visibility]) // Combined index for common queries
}

model sessions {
  id            String   @id
  session_token String   @unique
  user_id       String
  expires       DateTime
  created_at    DateTime @default(now())
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model users {
  id            String @id
  email         String @unique
  password_hash String
  name          String

  // Enhanced role system
  role              String  @default("student") // student | faculty | pending_faculty | admin
  is_super_admin    Boolean @default(false)
  account_status    String  @default("active") // active | suspended | pending_approval | deleted

  // Student-specific fields
  major              String?
  graduation_year    Int?
  academic_interests String[] @default([])

  // Faculty-specific fields
  title         String? // Professor, Lecturer, Researcher, etc.
  department    String?
  research_area String? // Primary research area/speciality

  // General profile fields (both student and faculty)
  about       String?  @db.Text
  university  String?
  avatar_url  String?

  // Legacy field (kept for backward compatibility)
  speciality        String? // Deprecated: use research_area instead
  interested_fields String[] @default([]) // Deprecated: use academic_interests instead

  // Academic & Social Links
  google_scholar_url   String?
  personal_website_url String?
  linkedin_url         String?
  twitter_url          String?
  github_url           String?

  // Email verification
  email_verified                   Boolean   @default(false)
  email_verified_at                DateTime?
  email_verification_token         String?   @unique
  email_verification_token_expires DateTime?
  last_verification_email_sent_at  DateTime?

  // Password reset
  password_reset_token   String?   @unique
  password_reset_expires DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Content relations
  courses              courses[]
  media_files          media_files[]
  modules              modules[]
  sessions             sessions[]
  playgrounds          playgrounds[]
  playground_templates playground_templates[]

  // Collaboration relations
  course_collaborations_as_user    course_collaborators[]   @relation("CourseCollaborator")
  course_collaborations_as_inviter course_collaborators[]   @relation("CourseInviter")
  module_collaborations_as_user    module_collaborators[]   @relation("ModuleCollaborator")
  module_collaborations_as_inviter module_collaborators[]   @relation("ModuleInviter")
  collaboration_activities         collaboration_activity[]

  // Course tracking relations (learning - any user can enroll)
  started_courses course_tracking[] @relation("CourseTracking")

  // Progress tracking (Week 4)
  module_progress module_progress[] @relation("ModuleProgress")

  // Admin & approval relations
  faculty_request       faculty_requests?       @relation("FacultyRequester")
  reviewed_requests     faculty_requests[]      @relation("FacultyReviewer")
  admin_actions         admin_audit_logs[]      @relation("AdminActor")

  // Gamification relations (Quest Map Feature)
  achievements          user_achievements[]     @relation("UserAchievements")
  gamification_stats    user_gamification_stats? @relation("UserGamificationStats")
  learning_sessions     learning_sessions[]     @relation("LearningSession")

  // Curriculum & Learning Paths (Curriculum Visualization Feature)
  created_learning_paths learning_paths[]       @relation("LearningPathCreator")

  @@index([role])
  @@index([account_status])
  @@index([email])
}

// ==================== PLAYGROUND BUILDER MODELS ====================

model playground_templates {
  id          String  @id @default(cuid())
  name        String
  description String
  category    String // neural_networks, physics, algorithms, data_viz, etc.
  thumbnail   String?

  // App type (shinylive, pyodide, etc.)
  app_type String @default("shinylive")

  // Shinylive fields (primary approach)
  source_code  String?  @db.Text // Full Shiny app.py code
  requirements String[] @default([]) // Python packages (e.g., ["plotly", "numpy"])

  // Legacy fields (optional, for backward compatibility)
  default_controls      Json? // ControlConfig[] (deprecated)
  default_visualization Json? // VisualizationConfig (deprecated)
  code_template         String? @db.Text // (deprecated, use source_code)

  // Required libraries (legacy)
  python_libraries String[] @default([])
  js_libraries     String[] @default([])

  // Metadata
  author_id String?
  version   String   @default("1.0.0")
  tags      String[]
  is_public Boolean  @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  author      users?        @relation(fields: [author_id], references: [id], onDelete: SetNull)
  playgrounds playgrounds[]

  @@index([category])
  @@index([author_id])
  @@index([is_public])
  @@index([app_type])
}

model playgrounds {
  id          String @id @default(cuid())
  title       String
  description String @db.Text
  category    String

  // Ownership & Permissions
  created_by      String
  organization_id String?
  is_public       Boolean @default(false)
  share_url       String  @unique @default(cuid())

  // App type (shinylive, pyodide, etc.)
  app_type String @default("shinylive")

  // Shinylive fields (primary approach)
  source_code  String?  @db.Text // Full Shiny app.py code
  requirements String[] @default([]) // Python packages

  // Template & Configuration
  template_id String?

  // Legacy fields (optional, for backward compatibility)
  controls      Json? // ControlConfig[] (deprecated)
  visualization Json? // VisualizationConfig (deprecated)
  code_config   Json? // CodeConfig (deprecated)

  // Metadata
  published_at DateTime?
  version      Int       @default(1)

  // Analytics
  view_count Int    @default(0)
  fork_count Int    @default(0)
  rating     Float?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  author   users                 @relation(fields: [created_by], references: [id], onDelete: Cascade)
  template playground_templates? @relation(fields: [template_id], references: [id], onDelete: SetNull)

  @@index([created_by])
  @@index([template_id])
  @@index([category])
  @@index([is_public])
  @@index([share_url])
  @@index([app_type])
}

// ==================== COLLABORATION MODELS ====================

model course_collaborators {
  id        String @id @default(cuid())
  course_id String
  user_id   String

  // Metadata
  added_by String? // Nullable - preserves collaboration if inviter deleted
  added_at DateTime @default(now())

  // Activity metrics (for analytics)
  last_accessed DateTime @default(now())
  edit_count    Int      @default(0)

  // Relations
  course       courses @relation(fields: [course_id], references: [id], onDelete: Cascade)
  collaborator users   @relation("CourseCollaborator", fields: [user_id], references: [id], onDelete: Cascade)
  inviter      users?  @relation("CourseInviter", fields: [added_by], references: [id], onDelete: SetNull)

  // Constraints
  @@unique([course_id, user_id]) // Prevent duplicate collaborators
  @@index([course_id]) // Fast lookup by course
  @@index([user_id]) // Fast lookup by user
  @@index([added_by]) // For audit trails
}

model course_tracking {
  id            String   @id @default(cuid())
  course_id     String
  user_id       String   // Changed from student_id - allows any user (student, faculty, admin) to enroll
  started_at    DateTime @default(now())
  last_accessed DateTime @default(now())
  status        String   @default("active") // active (for future: completed, dropped)

  // Progress tracking (Week 4)
  completion_pct    Float @default(0) // 0-100 percentage
  modules_completed Int   @default(0) // Count of completed modules
  modules_total     Int   @default(0) // Total modules in course

  // Relations
  course courses @relation(fields: [course_id], references: [id], onDelete: Cascade)
  user   users   @relation("CourseTracking", fields: [user_id], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([course_id, user_id]) // Prevent duplicate course starts
  @@index([user_id, started_at(sort: Desc)]) // Fast lookup for user dashboard
  @@index([course_id, started_at(sort: Desc)]) // Fast lookup for faculty view
}

model module_collaborators {
  id        String @id @default(cuid())
  module_id String
  user_id   String

  // Metadata
  added_by String?
  added_at DateTime @default(now())

  // Activity metrics
  last_accessed DateTime @default(now())
  edit_count    Int      @default(0)

  // Relations
  module       modules @relation(fields: [module_id], references: [id], onDelete: Cascade)
  collaborator users   @relation("ModuleCollaborator", fields: [user_id], references: [id], onDelete: Cascade)
  inviter      users?  @relation("ModuleInviter", fields: [added_by], references: [id], onDelete: SetNull)

  // Constraints
  @@unique([module_id, user_id])
  @@index([module_id])
  @@index([user_id])
  @@index([added_by])
}

model collaboration_activity {
  id          String @id @default(cuid())
  entity_type String // 'course' | 'module'
  entity_id   String // Course or module ID
  user_id     String

  // Action details
  action      String // 'created' | 'updated' | 'published' | 'deleted' | 'invited_user' | 'removed_user'
  description String @db.Text // Human-readable

  // Detailed change log (JSON for flexibility)
  changes Json? // { field: 'title', from: 'Old', to: 'New', ... }

  created_at DateTime @default(now())

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([entity_type, entity_id, created_at(sort: Desc)]) // Primary query pattern
  @@index([user_id, created_at(sort: Desc)]) // User activity history
  @@index([action]) // Filter by action type
  @@index([created_at(sort: Desc)]) // Cleanup old records
}

// ==================== ADMIN & APPROVAL MODELS ====================

model faculty_requests {
  id      String @id @default(cuid())
  user_id String @unique

  // Request details
  request_statement String   @db.Text
  requested_at      DateTime @default(now())

  // Review tracking
  approval_status String    @default("pending") // pending | approved | declined
  reviewed_by     String? // admin user_id
  reviewed_at     DateTime?
  admin_note      String?   @db.Text
  decline_reason  String?   @db.Text

  // Relations
  requester users  @relation("FacultyRequester", fields: [user_id], references: [id], onDelete: Cascade)
  reviewer  users? @relation("FacultyReviewer", fields: [reviewed_by], references: [id], onDelete: SetNull)

  @@index([approval_status])
  @@index([requested_at(sort: Desc)])
  @@index([reviewed_by])
}

model admin_audit_logs {
  id       String @id @default(cuid())
  admin_id String

  // Action details
  action      String // approved_faculty | declined_faculty | deleted_user | edited_content | etc.
  target_type String? // user | course | module | content_flag
  target_id   String?

  // Metadata
  reason      String? @db.Text
  details     Json? // Additional context (old_value, new_value, cascade info, etc.)
  ip_address  String?
  user_agent  String?

  // Timestamp
  created_at DateTime @default(now())

  // Relations
  admin users @relation("AdminActor", fields: [admin_id], references: [id], onDelete: Cascade)

  @@index([admin_id])
  @@index([action])
  @@index([created_at(sort: Desc)])
  @@index([target_type, target_id])
}

// ==================== PROGRESS TRACKING (WEEK 4) ====================

model module_progress {
  id           String    @id @default(cuid())
  user_id      String    // Learner (student, faculty, or admin)
  module_id    String
  course_id    String?   // Link to enrolled course (NULL for standalone progress)

  // Completion tracking (enhanced for quest map)
  status       String    @default("not_started") // not_started | available | in_progress | completed
  completed_at DateTime? // When marked complete
  started_at   DateTime? // When first accessed

  // Gamification (Quest Map Feature)
  xp_earned    Int       @default(0) // XP earned from this module
  attempts     Int       @default(0) // Number of attempts (for challenge modules)

  // Metadata
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  user   users    @relation("ModuleProgress", fields: [user_id], references: [id], onDelete: Cascade)
  module modules  @relation("ModuleProgressRecords", fields: [module_id], references: [id], onDelete: Cascade)
  course courses? @relation("CourseProgress", fields: [course_id], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([user_id, module_id, course_id]) // One progress record per user+module+course (nulls allowed)
  @@index([user_id]) // Fast lookup by user
  @@index([module_id]) // Fast lookup by module
  @@index([course_id]) // Fast lookup by course
  @@index([status]) // Filter by completion status
  @@index([user_id, course_id]) // Common query pattern
  @@index([user_id, module_id]) // For standalone progress queries
}

// ==================== GAMIFICATION (QUEST MAP FEATURE) ====================

model achievements {
  id           String   @id @default(cuid())
  title        String
  description  String   @db.Text
  icon         String   // emoji or lucide icon name
  category     String   // completion | speed | consistency | mastery
  criteria     Json     // { type: 'complete_n_modules', count: 10, ... }
  xp_reward    Int      @default(0)
  badge_color  String   @default("gray") // gray | bronze | silver | gold
  created_at   DateTime @default(now())

  // Relations
  user_achievements user_achievements[]

  @@index([category])
}

model user_achievements {
  id             String   @id @default(cuid())
  user_id        String
  achievement_id String
  earned_at      DateTime @default(now())
  progress       Int      @default(100) // % progress if partially earned (100 = fully earned)

  // Relations
  user        users        @relation("UserAchievements", fields: [user_id], references: [id], onDelete: Cascade)
  achievement achievements @relation(fields: [achievement_id], references: [id], onDelete: Cascade)

  @@unique([user_id, achievement_id])
  @@index([user_id])
  @@index([earned_at])
}

model user_gamification_stats {
  id                String    @id @default(cuid())
  user_id           String    @unique
  total_xp          Int       @default(0)
  level             Int       @default(1)
  current_streak    Int       @default(0) // days
  longest_streak    Int       @default(0) // days
  last_active_date  DateTime?
  total_time_minutes Int      @default(0)

  // Relations
  user users @relation("UserGamificationStats", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([total_xp])
  @@index([level])
}

model learning_sessions {
  id               String   @id @default(cuid())
  user_id          String
  date             DateTime @db.Date // One record per user per day
  minutes_studied  Int      @default(0)
  modules_viewed   Int      @default(0)
  modules_completed Int     @default(0)
  courses_accessed Int      @default(0)
  first_activity   DateTime?
  last_activity    DateTime?
  created_at       DateTime @default(now())

  // Relations
  user users @relation("LearningSession", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, date])
  @@index([user_id])
  @@index([date])
}

model learning_paths {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?  @db.Text
  course_ids  String[] @default([]) // Ordered array of course IDs in this path
  is_featured Boolean  @default(false)
  sort_order  Int      @default(0)
  created_by  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  creator users @relation("LearningPathCreator", fields: [created_by], references: [id], onDelete: Restrict)

  @@index([created_by])
  @@index([is_featured])
  @@index([slug])
}
